<!DOCTYPE html>
<html>
<head>
    <title>PlanningGame</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Niks.Apps.PlanningGame",{extend:"Rally.app.App",componentCls:"app",itemId:"pokerApp",_GC:{},config:{configFieldName:"c_PlanningPokerConfig",configSplitter:"^",showVotePanel:!1},statics:{SAVE_FAIL_RETRIES:5},listeners:{removeGame:function(){var e=[];_.each(Object.keys(pokerMsg),function(t){e.push({property:"Text",operator:"contains",value:pokerMsg[t]})});var t=this;Ext.create("Rally.ui.dialog.ConfirmDialog",{title:"Clean up from game",message:"Remove all game generated posts?",confirmLabel:"Yes",listeners:{confirm:function(){Ext.create("Rally.data.wsapi.Store",{model:"ConversationPost",filters:Rally.data.wsapi.Filter.or(e),autoLoad:!0,context:t.getContext().getDataContext(),listeners:{load:function(e,o,i){var s=o.length,r=[];i&&(_.each(o,function(e){r.push(e.destroy())}),Deft.Promise.all(r).then({success:function(){Rally.ui.notify.Notifier.showWarning({message:Ext.String.format(" {0} Records Deleted",s)}),t._reloadGame()}}))}}})}}})},switchpanel:function(){this.showVotePanel?(this.showVotePanel=!1,this.userPage.hide(),this.modPage.show()):(this.showVotePanel=!0,this.userPage.show(),this.modPage.hide())},configsave:function(){this._saveProjectConfig()},configchanged:function(){this._saveProjectConfig().then({success:function(){this._reloadGame()},failure:function(e){console.log("Failed to save project config",e)},scope:this})},refresh:function(){Rally.ui.notify.Notifier.show({message:"Refreshing Game"}),this._startGame()},showConfig:function(){this._iAmModerator()&&this._GC.showPanel()},changeIteration:function(){this._iAmModerator()&&this._IC.showPanel()},cardselected:function(e){console.log("cardselected: ",e),this._UC.selectCard(e),this._iAmModerator()&&this._MC.selectCard(e),this._UC.setVoting(e,this._GC.getNamedConfig(mainConfigName))&&(this._storySelected=e)},voteselected:function(e){this._voteSelected=e,this._UC.setVote(e)},postvote:function(){var e=this;this._voteSelected&&this._storySelected&&Rally.data.ModelFactory.getModel({type:"ConversationPost",success:function(t){Ext.create(t,{Text:"<p>"+pokerMsg.votePosted+":"+JSON.stringify(e._voteSelected)+"</p>",Artifact:e._storySelected.story.get("_ref")}).save({callback:function(t,o){o.wasSuccessful()?(Rally.ui.notify.Notifier.show({message:Ext.String.format("Vote Posted on {0} was {1}",e._storySelected.story.get("FormattedID"),e.getSetting("useTShirt")?e._voteSelected.size:e._voteSelected.value)}),e._storySelected.postedVote()):Rally.ui.notify.Notifier.showWarning({message:"Failed to post vote. Please retry"})}})}})}},_voteSelected:null,_storySelected:null,_processStoryChanges:function(){this._reloadGame()},_reloadGame:function(){this._kickOff()},_iAmModerator:function(){return this.getContext().getUser().ObjectID===this._GC.getModerator().get("ObjectID")},_setUpUserScreen:function(){var e=this._iAmModerator();if(e){this.modPage=this._MC.restart(!0),this._MC.addSwitch(),this.modPage.show(),this.userPage=this._UC.restart(!1),this._UC.addSwitch(),this.userPage.hide();this._GC.getConfigValue("allowIterationSelector")?this._MC.enableIterationButton():this._MC.disableIterationButton()}else this.userPage=this._UC.restart(!1),this.userPage.show();this._storyStore&&(e&&this._MC.loadStories(this._storyStore.getRecords()),this._UC.loadStories(this._storyStore.getRecords()))},_getStoryStore:function(e){var t=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.artifact.Store",{models:this._GC.getConfigValue("artefactTypes"),context:this.getContext().getDataContext(),autoLoad:!0,pageSize:storyFetchLimit,limit:storyFetchLimit,sorters:[{property:"DragAndDropRank",dir:"DESC"}],fetch:["FormattedID","TargetDate","Description","Discussion","LatestDiscussionAgeInMinutes","LastUpdateDate","Name","State","ScheduleState","Owner","PlanEstimate"],filters:e,listeners:{load:function(e,o,i){i?(storeLoadTime=new Date,Rally.ui.notify.Notifier.show({message:Ext.String.format("Loaded {0} stories",o.length)}),t.resolve(e)):(Rally.ui.notify.Notifier.showWarning({message:"No stories found in this iteration/project node"}),t.reject(null))},scope:this}}),t.promise},_kickOff:function(){var e=this;e._IC.getCurrentIteration().then({success:function(t){var o=[],i=e._GC.getConfigValue("storyFilter");i&&o.push(Rally.data.wsapi.Filter.fromQueryString(i)),e._GC.getConfigValue("allowIterationSelector")&&o.push({property:"Iteration",value:t}),o=Rally.data.wsapi.Filter.and(o)||[],e._getStoryStore(o).then({success:function(t){e._storyStore=t},failure:function(e){console.log("Fatal failure to load stories. Clean out the project config and start again",e)}}).always(function(){e._setUpUserScreen()})},failure:function(e){console.log("Didn't find a 'current' iteration",e)}})},_loadGameConfig:function(){var e=this;if(this._UC.useTShirtSizing(this._GC.getConfigValue("useTShirt")),this._iAmModerator()){this._MC.useTShirtSizing(this._GC.getConfigValue("useTShirt"));var t=this.projectStore.getRecords()[0];t.get("TeamMembers").Count>0?t.getCollection("TeamMembers").load({fetch:!0,filters:[{property:"Disabled",value:!1}],callback:function(t,o,i){!0===i?(Rally.ui.notify.Notifier.show({message:"Team members loaded"}),_.each(t,function(t){e._MC.addUser(t)}),e._kickOff()):console.log("Team members field unavailable")},scope:e}):Rally.ui.notify.Notifier.showWarning({message:"Team members not configured"})}else e._kickOff()},launch:function(){var e=this;e._GC=Ext.create("Niks.Apps.PokerGameConfig",{app:e,project:e.getContext().getProject()}),e._UC=Ext.create("Niks.Apps.PokerUserConfig",{app:e,project:e.getContext().getProject()}),e._MC=Ext.create("Niks.Apps.PokerUserConfig",{app:e,project:e.getContext().getProject()}),e._IC=Ext.create("Niks.Apps.PokerIterationConfig",{app:e,project:e.getContext().getProject()}),this._startGame()},_startGame:function(){var e=this;this._checkProjectFieldConfig().then({success:function(){this._getProjectConfig().then({success:function(t){t.hasOwnProperty("moderatorID")?e._GC.setModeratorFromId(t.moderatorID).then({success:function(){e._loadGameConfig()},failure:function(){console.log("Failed to set moderator from ID")}}):Ext.create("Rally.ui.dialog.ConfirmDialog",{title:"New Config",message:"Are you moderator for this session?",listeners:{confirm:function(){e._GC.setModeratorFromId(e.getContext().getUser()[userIdField]).then({success:function(){e._saveProjectConfig().then({success:function(){e._loadGameConfig()},failure:function(e){console.log("Failed to save project config",e)},scope:e})}})}}})},failure:function(e){Rally.ui.notify.Notifier.showWarning({message:e}),console.log(e)},scope:e})},failure:function(e){Rally.ui.notify.Notifier.showWarning({message:e}),console.log(e)},scope:e})},_createStoryBrowser:function(){return Ext.create("Deft.Deferred").promise},_createUserMenu:function(){return Ext.create("Deft.Deferred").promise},_createLeadMenu:function(){return Ext.create("Deft.Deferred").promise},_checkProjectFieldConfig:function(){var e=this,t=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:"Project",fetch:!0,success:function(o){o.hasField(e.configFieldName)&&"string"===o.getField(e.configFieldName).type.type?t.resolve(o):t.reject("Correct Config on Project artefact not available")},failure:function(){t.reject("Failed to get Project Model")}}),t.promise},_getProjectConfig:function(){var e=this,t=Ext.create("Deft.Deferred"),o=this.getContext().getProject();return e.projectStore=Ext.create("Rally.data.wsapi.Store",{model:"Project",filters:[{property:"ObjectID",value:o.ObjectID}],autoLoad:!0,fetch:!0,listeners:{load:function(o,i){e._GC.initialiseConfig(i[0].get(this.configFieldName)),e._UC.setConfig(e._GC.getNamedConfig(userConfigName)),e._MC.setConfig(e._GC.getNamedConfig(userConfigName)),e._IC.setConfig(e._GC.getNamedConfig(iterConfigName));var s=e._GC.getNamedConfig(mainConfigName);t.resolve(s)},scope:e}}),t.promise},_failedSave:0,_saveProjectConfig:function(e){this._GC.updateNamedConfig(iterConfigName,this._IC.getConfig()),this._GC.updateNamedConfig(userConfigName,this._MC.getConfig());var t=void 0===e?Ext.create("Deft.Deferred"):e,o=this._GC.getGameConfig(),i=this.projectStore.getRecords()[0];return i.set(this.configFieldName,o),i.save({success:function(){this._failedSave=0,Rally.ui.notify.Notifier.show({message:"Config Saved to Project"}),t.resolve()},failure:function(){this._failedSave<this.self.SAVE_FAIL_RETRIES?this._saveProjectConfig(t):t.reject("Failed to save Project Config")},scope:this}),t.promise},_checkConfigChange:function(e){console.log(e)},_createConfigPage:function(){return Ext.create("Deft.Deferred").promise},_createUserPage:function(){return Ext.create("Deft.Deferred").promise},_createLeadPage:function(){return Ext.create("Deft.Deferred").promise}});
                const modChange="moderatorchanged",configChange="configchanged",configSave="configsave",mainConfigName="MainConfig",userConfigName="UserConfig",iterConfigName="IterConfig",cardWidth=400,cardHeight=300,cardMargin=10,cardSizeField="PlanEstimate",cardIdField="FormattedID",configSplitter1="^",configSplitter2="|",votingTime="00:10",userIdField="ObjectID",storyFetchLimit=50,pokerMsg={votePosted:"POKER_VOTE_POSTED"},valueSeries=[{size:"XS",value:1},{size:"S",value:2},{size:"M",value:3},{size:"L",value:5},{size:"XL",value:8},{size:"XXL",value:13},{size:"XXXL",value:20},{size:"Too Big",value:40}];
                Ext.define("Niks.Apps.Panel",{bubbleEvents:[],constructor:function(n){this.users=[],Ext.applyIf(this,n)},getPanel:function(n){return this.configPanel||this._createPanel(n)},showPanel:function(){this.getPanel().show()},hidePanel:function(){this.getPanel().hide()},destroyPanel:function(){this.configPanel&&(this.getPanel().destroy(),this.configPanel=null)}});
                Ext.define("Niks.Apps.PokerGameConfig",{extend:Niks.Apps.Panel,id:mainConfigName+"Panel",userIDs:[],moderatorUser:null,initialiseConfig:function(e){this[mainConfigName]=this._decodeConfig(mainConfigName,e),this[userConfigName]=this._decodeConfig(userConfigName,e),this[iterConfigName]=this._decodeConfig(iterConfigName,e),this[mainConfigName].votingTime||(this[mainConfigName].votingTime=votingTime),this[mainConfigName].artefactTypes&&this[mainConfigName].artefactTypes.length||(this[mainConfigName].artefactTypes=["UserStory","Defect"])},getNamedConfig:function(e){return this[e]||{}},updateNamedConfig:function(e,i){this[e]=i},_decodeConfig:function(e,i){if(void 0===i||0===i.length)return{};var t=i.split(configSplitter1),a={};return _.each(t,function(e){var i=e.split(configSplitter2);i[0].length&&(a[i[0]]=i[1])}),JSON.parse(a[e]||"{}")},addUser:function(e){_.find(this.userIDs,{userOID:e.get(userIdField)})?console.log("Adding existing member - ignoring!"):this.userIDs.push(e[userIdField])},getModerator:function(){return this.moderatorUser?this.moderatorUser:null},setModerator:function(e){console.log("mod set to:",e),this[mainConfigName].moderatorID=e.get(userIdField),this.moderatorUser=e},setModeratorFromId:function(e){var i=this,t=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"User",autoLoad:!0,filters:[{property:userIdField,value:e}],listeners:{load:function(e,a,n){n?(i.setModerator(a[0]),t.resolve(a[0])):t.reject()}}}),t.promise},getConfigValue:function(e){return this[mainConfigName][e]},_encodeMsg:function(e,i){return configSplitter1+e+configSplitter2+i},_decodeMsg:function(e,i){return i.split(configSplitter2).pop()},getGameConfig:function(){return this._encodeMsg(mainConfigName,JSON.stringify(this[mainConfigName]))+this._encodeMsg(userConfigName,JSON.stringify(this[userConfigName]))+this._encodeMsg(iterConfigName,JSON.stringify(this[iterConfigName]))},_createPanel:function(){var e=this,i=Ext.create("Ext.panel.Panel",{floating:!0,draggable:!0,width:400,height:400,baseCls:"configPanel",hidden:!0,closable:!0,closeAction:"hide"});return i.add({xtype:"field",id:"curMod",fieldLabel:"Current Moderator",labelWidth:200,margin:"10 0 10 20",baseBodyCls:"textfield",readOnly:!0,value:e.moderatorUser?e.moderatorUser.get("UserName"):"Not Set"}),i.add({xtype:"rallyusercombobox",id:"modChooser",fieldLabel:"Change Moderator To",valueField:userIdField,labelWidth:200,margin:"10 0 10 20",autoSelect:!1,listeners:{select:function(t){null!==t.value&&(e.setModerator(t.lastSelection[0]),i.down("#curMod").setValue(e.moderatorUser.get("UserName")),Ext.create("Rally.ui.dialog.ConfirmDialog",{title:"New Moderator",message:"Restart session?",listeners:{confirm:function(){e.app.fireEvent(configChange),e.hidePanel()}}}))}}}),i.add({xtype:"rallycheckboxfield",fieldLabel:"Enable Iteration Selector",id:"allowIterationSelector",value:e[mainConfigName].allowIterationSelector,labelWidth:200,margin:"10 0 10 20",listeners:{change:function(i,t,a,n){e[mainConfigName].allowIterationSelector=t,e.app.fireEvent(configChange)}}}),i.add({xtype:"rallycheckboxfield",fieldLabel:"Use T-Shirt sizing",id:"useTShirt",value:e[mainConfigName].useTShirt,labelWidth:200,margin:"10 0 10 20",listeners:{change:function(i,t,a,n){e[mainConfigName].useTShirt=t,e.app.fireEvent(configChange)}}}),i.add({xtype:"textfield",baseCls:"timerText",fieldLabel:"Voting Time (min:sec)",labelWidth:200,margin:"10 0 10 20",value:e[mainConfigName].votingTime||votingTime,validator:function(i){return void 0!==Ext.Date.parse(i,"i:s")&&(e[mainConfigName].votingTime=i,e.app.fireEvent(configSave),!0)}}),i.add({xtype:"container",margin:"10 0 10 20",layout:"hbox",items:[{xtype:"rallycheckboxfield",id:"selectStories",fieldLabel:"Stories",margin:"0 10 0 0",listeners:{change:function(i,t){t?e[mainConfigName].artefactTypes=_.union(e[mainConfigName].artefactTypes,["UserStory"]):(e[mainConfigName].artefactTypes=_.without(e[mainConfigName].artefactTypes,"UserStory"),!1===e.getPanel().down("#selectDefects").getValue()&&e.getPanel().down("#selectDefects").setValue(!0)),e.app.fireEvent(configChange)}},value:_.indexOf(e[mainConfigName].artefactTypes,"UserStory")>0},{xtype:"rallycheckboxfield",fieldLabel:"Defects",id:"selectDefects",margin:"0, 10 0 0",listeners:{change:function(i,t){t?e[mainConfigName].artefactTypes=_.union(e[mainConfigName].artefactTypes,["Defect"]):(e[mainConfigName].artefactTypes=_.without(e[mainConfigName].artefactTypes,"Defect"),!1===e.getPanel().down("#selectStories").getValue()&&e.getPanel().down("#selectStories").setValue(!0)),e.app.fireEvent(configChange)}},value:_.indexOf(e[mainConfigName].artefactTypes,"Defect")>0}]}),i.add({xtype:"textarea",fieldLabel:"Artefact Filter",name:"query",cls:"query-field",labelAlign:"top",width:360,value:e[mainConfigName].storyFilter,margin:"0 20 0 20",validateOnBlur:!0,validateOnChange:!1,validator:function(i){try{return i&&Rally.data.wsapi.Filter.fromQueryString(i),e[mainConfigName].storyFilter=i,e.app.fireEvent(configChange),!0}catch(e){return e.message}}}),this.configPanel=i,i}});
                Ext.define("Niks.Apps.PokerCard",{extend:Ext.panel.Panel,margin:cardMargin,layout:{type:"vbox",align:"left"},autoScroll:!0,config:{story:null,voteSize:null},applyVoteSize:function(t){this.voteSize=t;var e=this,i=Ext.create("Rally.ui.Button",{margin:10,disabled:!0,text:(t.tshirt?t.size:t.value).toString(),cls:"buttontext",width:this.width-22,height:this.height-22,handler:function(){this.up("#pokerApp").fireEvent("voteselected",e.voteSize)}});this.add(i)},postedVote:function(){this.voted=this.vote,this.setVoteString()},setVoteString:function(t){t&&t!==this.vote&&(this.vote=t),t&&t!==this.vote||this.vote!==this.voted?(this.tf.removeCls("definedfield"),this.tf.addCls("erroredfield")):(this.tf.addCls("definedfield"),this.tf.removeCls("erroredfield"));var e=this.story.get(cardSizeField);e=null===e?0===e?"set to zero":"not set":e.toString(),this.tf.update(Ext.String.format("Current Size: {0} {1} {2}",e,this.vote?" - You chose: "+(this.vote.tshirt?this.vote.size:this.vote.value):"",this.voted?" and have voted: "+(this.voted.tshirt?this.voted.size:this.voted.value):""))},applyStory:function(t){this.story=t,this.tf=Ext.create("Ext.form.field.Text",{xtype:"textfield",id:"sizeText"+t.get(cardIdField),width:cardWidth-30,margin:"5 0 5 10",cls:"definedfield"}),this.add(this.tf),this.setVoteString();var e=t.get("Description");e=e.length?e:"<p>Description field Empty</p><p><b>Please go to Artefact and enter a Description of the Required Effort</b></p>";var i=Ext.create("Ext.form.Label",{margin:cardMargin,forId:"sizeText"+t.get(cardIdField),width:cardWidth-40,grow:!0,hideLabel:!0,readOnly:!0,autoScroll:!0,html:e});this.add(i),this.getEl().on("click",function(t,e){"A"!==e.nodeName&&this.up("#pokerApp").fireEvent("cardselected",this)},this)}});
                Ext.define("Niks.Apps.PokerUserConfig",{extend:Niks.Apps.Panel,getConfig:function(){return this[userConfigName]},setConfig:function(e){this[userConfigName]=e},addUser:function(e){_.find(this.users,function(t){if(e.get("ObjectID")===t.get("ObjectID"))return!0})||this.users.push(e)},restart:function(e){this.stories=[],this.destroyPanel();var t=this.getPanel(e);return this.cardSelected=null,e&&this._doVotes(),t},loadStories:function(e){var t=this;t.getPanel().down("#cardspace")&&t.getPanel().down("#cardspace").removeAll(!1),t.stories=[],_.each(e,function(e){t._addCardToPage(e)})},_addCardToPage:function(e){var t=this.getPanel().down("#cardspace"),n=Ext.create("Niks.Apps.PokerCard",{title:Ext.String.format('<table><tr><td><a target="_blank" href={1}>{0} </a><a target="_blank" href={2} class="icon-chat"></a></td><td class="rightAlignField"><p class="rightAlignField">{3}</p></td></tr></table>',e.get(cardIdField),Rally.nav.Manager.getDetailUrl(e,{subPage:""}),Rally.nav.Manager.getDetailUrl(e,{subPage:"discussion"}),e.get("Name")),width:cardWidth,height:cardHeight});t.add(n),n.setStory(e),this.stories.push(n)},selectCard:function(e,t){var n=_.find(this.stories,function(t){return e.story.get(cardIdField)===t.story.get(cardIdField)});n===this.cardSelected?(this.cardSelected.removeCls("cardSelected"),this.cardSelected=null):(n.addCls("cardSelected"),this.cardSelected&&this.cardSelected.removeCls("cardSelected"),this.cardSelected=n)},setVoting:function(e,t){var n=this;this.votingCard=e,this[mainConfigName]=t;var i=this.getPanel().down("#actions");if(this.userOrModerator)return this.timerRunning?(Ext.create("Rally.ui.dialog.ConfirmDialog",{title:"Cancel current voting",message:"Stop the timer for the current session?",confirmLabel:"Yes, please",listeners:{confirm:function(){n._stopTimer(),n._configureTimer(i)},scope:n}}),!1):(this._configureTimer(i),!0);var a=_.find(this.stories,function(t){return e.story.get(cardIdField)===t.story.get(cardIdField)});a&&a.vote?n.setVote(a.vote):n.clearVote();var r=this.configPanel.down("#actions");return this.cardSelected?_.each(r.getChildItemsToDisable(),function(e){e.enable()}):(_.each(r.getChildItemsToDisable(),function(e){e.disable()}),this.getPanel().down("#votemessage").update("Choose an item &rarr;")),!0},refreshVotes:function(){this._doVotes()},addSwitch:function(){var e=this;this.getPanel().down("#menu").add({xtype:"rallybutton",width:100,text:"Switch View",margin:"10 10 0 10",handler:function(){e.app.fireEvent("switchpanel")}})},disableIterationButton:function(){this.getPanel().down("#iterationButton").disable()},enableIterationButton:function(){this.getPanel().down("#iterationButton").enable()},useTShirtSizing:function(e){this[userConfigName].useTShirt=e},setVote:function(e){var t=this;_.find(this.stories,function(e){return t.cardSelected.story.get(cardIdField)===e.story.get(cardIdField)}).setVoteString(e),this.getPanel().down("#votemessage").update("&larr; Vote "+(e.tshirt?e.size:e.value).toString())},clearVote:function(){this.getPanel().down("#votemessage").update("Choose a vote &darr;")},_timerRunning:0,_stopTimer:function(){this._timerRunning=0},_configureTimer:function(e){if(void 0!==this[mainConfigName]&&"00:00"!==this[mainConfigName].votingTime){var t=this[mainConfigName].votingTime.split(":");this._timerRunning=60*t[0]+t[1],this.configPanel.down("#countdowntimer").setValue(this[mainConfigName].votingTime),this.configPanel.down("#countdowntimer").getEl().removeCls("timerfinished"),this.configPanel.down("#countdowntimer").getEl().removeCls("textBlink"),this.configPanel.down("#countdowntimer").getEl().addCls("timerreset")}},_revealVotes:!1,_votes:null,_doVotes:function(){var e=this;e._getVotes().then({success:function(t){e._setVotes(t)}})},_setVotes:function(e){var t=this.configPanel.down("#votespanel");t.removeAll();var n=this.configPanel.down("#revealvotesbtn");!1===this._revealVotes?n.setText("Reveal Votes"):n.setText("Hide Votes"),t.add({html:"<u>Team Member</u>",width:160}),t.add({html:"<u>Vote Cast</u>",width:100}),t.add({html:"<u>When</u>",width:140}),_.each(this.users,function(n){var i=_.find(e,function(e){return e.get("User").ObjectID===n.get("ObjectID")}),a="&nbsp",r="&nbsp";void 0!==i&&(a=i.get("Text"),a=JSON.parse(a.split(pokerMsg.votePosted+":")[1].split("<")[0]),a=this._revealVotes?(a.tshirt?a.size+" ("+a.value+")":a.value).toString():"?",r=i.get("_CreatedAt")),t.add({html:n.get("_refObjectName")}),t.add({html:a}),t.add({html:r}),this.configPanel.down("#revealvotesbtn").enable()},this)},_getVotes:function(){var e=this;e._votes=null,e._revealVotes=!1;var t=Ext.create("Deft.Deferred");if(null===this.cardSelected)return Rally.ui.notify.Notifier.showWarning({message:"No item selected"}),t.resolve([]),t.promise;var n=[];_.each(this.users,function(e){n.push({property:"User",value:e.get("_ref")})});var i=[Rally.data.wsapi.Filter.or(n)];return i.push({property:"Artifact",value:this.cardSelected.story.get("_ref")}),i.push({property:"Text",operator:"contains",value:pokerMsg.votePosted}),Ext.create("Rally.data.wsapi.Store",{model:"ConversationPost",filters:Rally.data.wsapi.Filter.and(i),autoLoad:!0,sorters:[{property:"CreationDate",direction:"DESC"}],listeners:{load:function(n,i,a){a?(e._votes=i,t.resolve(i)):t.reject()},scope:e}}),t.promise},_countdownTimer:function(e){e._timerRunning>0?(e._decrementTimer(),e.configPanel.down("#countdowntimer").getEl().addCls("timerrunning"),e.configPanel.down("#countdowntimer").getEl().removeCls("timerfinished"),e.configPanel.down("#countdowntimer").getEl().removeCls("timerreset"),e._timerRunning-=1,setTimeout(e._countdownTimer,1e3,e)):(this.cardSelected&&(e.configPanel.down("#countdowntimer").getEl().removeCls("timerrunning"),e.configPanel.down("#countdowntimer").getEl().addCls("timerfinished"),e.configPanel.down("#countdowntimer").getEl().removeCls("textBlink"),e._doVotes()),e.configPanel.down("#countdowntimer").getEl().addCls("timerfinished"),e.configPanel.down("#countdowntimer").getEl().addCls("textBlink"))},_decrementTimer:function(){var e=this.configPanel.down("#countdowntimer").getValue().split(":");if(2===e.length){var t=60*e[0]+e[1];if(0!==t){var n=t-1,i=Math.floor(n/60);i=i<10?"0"+i:i.toString();var a=n%60;a=a<10?"0"+a:a.toString(),this.configPanel.down("#countdowntimer").setValue(i+":"+a)}}},_createPanel:function(e){var t=this;this.userOrModerator=e;var n=t.configPanel=Ext.create("Ext.container.Container",{width:"100%",hideMode:"display",height:t.app.getHeight(),layout:"hbox",itemId:e?"modPage":"userPage",items:[{xtype:"container",itemId:"menu",width:120,margin:cardMargin,cls:"clearpanel"},{xtype:"container",itemId:"actions",width:400,cls:"clearpanel"},{xtype:"container",itemId:"cardspaceparent",width:"50%",height:"100%",flex:1,cls:"clearpanel",autoScroll:!0}]});if(e)n.down("#actions").add({xtype:"container",margin:"10 0 0 0",cls:"userpanel",items:[{xtype:"textfield",itemId:"countdowntimer",height:50,margin:10,labelCls:"cardtext",fieldCls:"clearpanel timertext timerreset",fieldLabel:"Countdown Timer",labelAlign:"left",value:"00:00",readOnly:!0,labelWidth:120},{xtype:"container",layout:"hbox",items:[{xtype:"rallybutton",text:"Start",margin:10,width:100,handler:function(){null===this.cardSelected?Rally.ui.notify.Notifier.showWarning({message:"No story selected"}):t._countdownTimer(t)}},{xtype:"rallybutton",text:"Stop",margin:10,width:100,handler:function(){t._timerRunning=0}},{xtype:"rallybutton",text:"Reset",width:100,margin:10,handler:function(){t._configureTimer()}}]},{xtype:"panel",itemId:"votespanel",width:"100%",bodyCls:"userpanel",margin:"10 0 10 0",layout:{type:"table",columns:3},defaults:{bodyStyle:"padding:10px;border:none"}},{xtype:"container",layout:"hbox",items:[{xtype:"rallybutton",text:"Refresh Votes",margin:10,width:100,handler:function(){t._doVotes()}},{xtype:"rallybutton",itemId:"revealvotesbtn",text:"Reveal Votes",margin:10,width:100,disabled:!0,handler:function(){t._revealVotes=!t._revealVotes,t._setVotes(t._votes)}},{xtype:"rallybutton",margin:10,width:100,text:"Delete Votes",handler:function(){t.app.fireEvent("removeGame")}}]}]});else{n.down("#actions").add({xtype:"label",itemId:"votemessage",grow:!0,margin:10,hideLabel:!0,readOnly:!0,html:"Choose an item &rarr; ",cls:"clearpanel timertext"});var i=Ext.create("Ext.panel.Panel",{xtype:"panel",itemId:"sizespace",margin:10,layout:{type:"table",columns:2},bodyCls:"userpanel"});n.down("#actions").add(i),_.each(valueSeries,function(e){var n=Ext.create("Niks.Apps.PokerCard",{width:150,height:80});i.add(n),e.tshirt=t[userConfigName].useTShirt,n.setVoteSize(e)})}t.app.add(n);var a=n.down("#cardspaceparent");a.removeCls("x-panel-body-default");var r=Math.floor(a.getWidth()/(cardWidth+2*cardMargin));return r=r>0?r:1,a.add({xtype:"panel",itemId:"cardspace",margin:10,layout:{type:"table",columns:r},bodyCls:"userpanel"}),this.userOrModerator?(n.down("#menu").add({xtype:"rallybutton",width:100,text:"Config",margin:"10 10 0 10",handler:function(){t.app.fireEvent("showConfig")}}),n.down("#menu").add({xtype:"rallybutton",itemId:"iterationButton",width:100,text:"Iteration",margin:"10 10 0 10",handler:function(){t.app.fireEvent("changeIteration")}})):n.down("#menu").add({xtype:"rallybutton",width:100,text:"Vote Now",margin:"10 10 0 10",handler:function(){t.app.fireEvent("postvote")}}),n.down("#menu").add({xtype:"rallybutton",width:100,text:"Reload Game",margin:"10 10 0 10",handler:function(){t.app.fireEvent("refresh")}}),n}});
                Ext.define("Niks.Apps.PokerIterationConfig",{extend:Niks.Apps.Panel,id:iterConfigName+"Panel",constructor:function(){this.callParent(arguments),this[iterConfigName]={currentIteration:null}},getConfig:function(){return this[iterConfigName]},setConfig:function(e){Ext.merge(this[iterConfigName],e)},_createPanel:function(){var e=this,t=Ext.create("Ext.panel.Panel",{floating:!0,draggable:!0,width:400,baseCls:"configPanel",hidden:!0,closable:!0,closeAction:"hide"});return e.getCurrentIteration().then({success:function(r){t.add({xtype:"rallyiterationcombobox",margin:40,hideTrigger:!0,store:e._iterationStore,storeConfig:{autoLoad:!1},value:r,listeners:{select:function(t,r){Array.isArray(r)?e[iterConfigName].currentIteration=r[0].get("_ref"):e[iterConfigName].currentIteration=r.get("_ref"),e.app.fireEvent("configChanged")}}})}}),e.configPanel=t,t},getCurrentIteration:function(){var e=this;if(this[iterConfigName].currentIteration){var t=Ext.create("Deft.Deferred");return e._iterationStore?t.resolve(e[iterConfigName].currentIteration):e._getIterations(!1).then({success:function(){t.resolve(e[iterConfigName].currentIteration)}}),t.promise}return this._getIterations(!0)},_getIterations:function(e){var t=this,r=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:Ext.identityFn("Iteration"),autoLoad:!0,context:t.app.getContext().getDataContext(),fetch:["Name","StartDate","EndDate","ObjectID","State","PlannedVelocity"],filters:[{property:"EndDate",operator:">",value:new Date}],sorters:[{property:"StartDate",direction:"ASC"}],listeners:{load:function(n,i,a){a?(t._iterationStore=n,e&&n.totalCount&&(t[iterConfigName].currentIteration=n.getAt(0).get("_ref")),r.resolve(t[iterConfigName].currentIteration)):(Rally.ui.notify.Notifier.showWarning({message:"No appropriate Iterations available"}),r.reject())}}}),r.promise}});

            Rally.launchApp('Niks.Apps.PlanningGame', {
                name:"PlanningGame",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        .userpanel{border-left:1px solid black;border-top:none;border-right:1px solid black;border-bottom:none;background-color:whitesmoke}.clearpanel{border:none}.configPanel{opacity:1;background-color:palegoldenrod}.definedfield{border-style:none none solid none;border-color:black;border-width:1px}.erroredfield{border-style:none none solid none;border-color:red;border-width:1px}.timertext{font-size:36px}.timerrunning{background-color:teal}.timerfinished{background-color:tomato}.timerreset{background-color:white}.cardtext{color:black;font-size:12px;margin-left:5px}.cardSelected{border:3px #00a9e0 solid}.rightAlignField{text-align:right;width:60%;flex:auto}@keyframes textBlink{50%{opacity:0.5}}@-webkit-keyframes textBlink{50%{opacity:0.5}}.textBlink{animation:textBlink 1s step-start 0s infinite;-webkit-animation:textBlink 1s step-start 0s infinite}.votingSizeClass{font-size:36px;text-align:'center';color:#00a9e0;width:100}.buttonpushed{color:#78bee0}.buttontext{font-size:24px;text-align:'center'}
    </style>
</head>
<body>
</body>
</html>
