<!DOCTYPE html>
<html>
<head>
    <title>PlanningGame</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Niks.Apps.TeamPicker",{constructor:function(){this.callParent()}}),Ext.define("Niks.Apps.PlanningGame",{extend:"Rally.app.App",componentCls:"app",_gameConfig:{},config:{configFieldName:"c_PlanningPokerConfig",planningPokerTitle:"^"},statics:{SAVE_FAIL_RETRIES:5},listeners:{moderatorchanged:function(e){this._saveProjectConfig().then({success:function(){this._reloadGame()},failure:function(e){console.log("Failed to save project config",e)},scope:this})}},_reloadGame:function(){me._kickOff()},_kickOff:function(){var e=this;this._getCurrentIteration().then({success:function(t){var o=[];e._gameConfig.includeSizedStories()&&o.push({property:"PlanEstimate",operator:">",value:0}),e._storyStore=Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",filters:o,context:{projectScopeUp:!1,projectScopeDown:!1},autoLoad:!0,listeners:{load:function(t,o,i){i?(Rally.ui.notify.Notifier.show({message:Ext.String.format("Loaded {0} stories",o.length)}),e._gameConfig.showPanel()):Rally.ui.notify.Notifier.showWarning({message:"No stories found in this project node"})}}})},failure:function(e){console.log("Didn't find a 'current' iteration",e)}})},_loadGameConfig:function(){var e=this,t=this.projectStore.getRecords()[0];t.get("TeamMembers").Count>0?t.getCollection("TeamMembers").load({fetch:!0,callback:function(t,o,i){!0===i?(Rally.ui.notify.Notifier.show({message:"Team members loaded"}),_.each(t,function(t){e._gameConfig.addUser(t)}),e._kickOff()):console.log("Team members field unavailable")},scope:e}):Rally.ui.notify.Notifier.showWarning({message:"Team members not configured"})},launch:function(){var e=this;e._gameConfig=Ext.create("Niks.Apps.PokerGameConfig",{app:e}),this._checkProjectFieldConfig().then({success:function(t){this._getProjectConfig(t).then({success:function(t){var o={};t.length&&void 0!==(o=JSON.parse(t)).moderator?e._gameConfig.setModeratorFromId(o.moderator).then({success:function(){e._loadGameConfig()},failure:function(){console.log("Failed to set moderator from ID")}}):Ext.create("Rally.ui.dialog.ConfirmDialog",{title:"New Config",message:"Are you moderator for this session?",listeners:{confirm:function(){e._gameConfig.setModerator(e.getContext().getUser()),e._saveProjectConfig().then({success:function(){e._loadGameConfig()},failure:function(e){console.log("Failed to save project config",e)},scope:e})}}})},failure:function(e){console.log(e)},scope:e})},failure:function(e){console.log(e)},scope:e})},_createStoryBrowser:function(){return Ext.create("Deft.Deferred").promise},_createUserMenu:function(){return Ext.create("Deft.Deferred").promise},_createLeadMenu:function(){return Ext.create("Deft.Deferred").promise},_checkProjectFieldConfig:function(){var e=this,t=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:"Project",fetch:!0,success:function(o){o.hasField(e.configFieldName)?t.resolve(o):t.reject("Correct Config not available")},failure:function(){t.reject("Failed to get Project Model")}}),t.promise},_getProjectConfig:function(e){var t=Ext.create("Deft.Deferred"),o=this.getContext().getProject();return this.projectStore=Ext.create("Rally.data.wsapi.Store",{model:e.typeDefName,filters:[{property:"ObjectID",value:o.ObjectID}],autoLoad:!0,fetch:!0,listeners:{load:function(e,o){var i=this._decodeMsg("MainConfig",o[0].get(this.configFieldName));t.resolve(i)},scope:this}}),t.promise},_failedSave:0,_saveProjectConfig:function(e){var t=void 0===e?Ext.create("Deft.Deferred"):e,o=JSON.stringify(this._gameConfig.getGameConfig()),i=this.projectStore.getRecords()[0];return i.set(this.configFieldName,this._encodeMsg("MainConfig",o)),i.save({success:function(){this._failedSave=0,Rally.ui.notify.Notifier.show({message:"Config Saved to Project"}),t.resolve()},failure:function(){this._failedSave<this.self.SAVE_FAIL_RETRIES?this._saveProjectConfig(t):t.reject("Failed to save Project Config")},scope:this}),t.promise},_checkConfigChange:function(e){console.log(e)},_createConfigPage:function(){return Ext.create("Deft.Deferred").promise},_createUserPage:function(){return Ext.create("Deft.Deferred").promise},_createLeadPage:function(){return Ext.create("Deft.Deferred").promise},_encodeMsg:function(e,t){return this.planningPokerTitle+e+","+window.btoa(t)},_decodeMsg:function(e,t){return window.atob(t.split(",").pop())},_getCurrentIteration:function(){var e=Ext.create("Deft.Deferred");return this._iterationStore=Ext.create("Rally.data.wsapi.Store",{model:"Iteration",autoLoad:!0,context:{projectScopeUp:!1,projectScopeDown:!1},filters:[{property:"StartDate",operator:"<",value:new Date},{property:"EndDate",operator:">",value:new Date}],listeners:{load:function(t,o,i){e.resolve(o[0])}}}),e.promise}});
                const modChange="moderatorchanged";
                Ext.define("Niks.Apps.Panel",{bubbleEvents:[],constructor:function(n){Ext.applyIf(this,n)},getPanel:function(){return void 0===this.configPanel&&this._createPanel(),this.configPanel},showPanel:function(){this.getPanel().show()},hidePanel:function(){this.getPanel().hide()}});
                Ext.define("Niks.Apps.PokerGameConfig",{extend:Niks.Apps.Panel,mixins:{observable:Ext.util.Observable},iterationConfigs:[],activeStory:null,moderator:null,userConfigs:[],onlyUnsized:!1,statics:{userIdField:"ObjectID"},bubbleEvents:[modChange],addUser:function(e){_.find(this.userConfigs,{userOID:e.get(this.self.userIdField)})?console.log("Adding existing member - ignoring!"):this.userConfigs.push(e)},setModerator:function(e){this.moderator=e[this.self.userIdField],this.moderatorUser=e},setModeratorFromId:function(e){var t=this,i=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"User",autoLoad:!0,filters:[{property:this.self.userIdField,value:e}],listeners:{load:function(e,r,o){o?(t.setModerator(r[0]),i.resolve(r[0])):i.reject()}}}),i.promise},includeSizedStories:function(){return!this.onlyUnsized},getGameConfig:function(){return{iterationConfigs:this.iterationConfigs,activeStory:this.activeStory,moderator:this.moderator,userConfigs:this.userConfigs,onlyUnsized:this.onlyUnsized}},_createPanel:function(){var e=this,t=Ext.create("Ext.container.Container",{floating:!0,width:400,height:400,baseCls:"panel",hidden:!0});return t.add({xtype:"field",id:"curMod",fieldLabel:"Current Moderator",labelWidth:200,margin:"10 0 10 20",baseBodyCls:"textfield",readOnly:!0,value:e.moderatorUser?e.moderatorUser.get("DisplayName"):"Not Set"}),t.add({xtype:"rallyusercombobox",id:"modChooser",labelWidth:200,fieldLabel:"Change Moderator To",valueField:this.self.userIdField,margin:"10 0 10 20",autoSelect:!1,listeners:{setvalue:function(i){null!==i.value&&(e.setModerator(i.lastSelection[0]),t.down("#curMod").setValue(e.moderatorUser.get("DisplayName")),Ext.create("Rally.ui.dialog.ConfirmDialog",{title:"New Moderator",message:"Restart session?",listeners:{confirm:function(){e.app.fireEvent(modChange),e.hidePanel()}}}))}}}),this.configPanel=t,t}});
                Ext.define("Niks.Apps.PokerUserConfig",{userOID:null,constructor:function(e){this.callParent(),this.userOID=e.get("ObjectID")}});

            Rally.launchApp('Niks.Apps.PlanningGame', {
                name:"PlanningGame",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        .panel{border:'1px black'}.textfield{border-style:none none solid none;border-color:black;border-width:1px}
    </style>
</head>
<body>
</body>
</html>
