<!DOCTYPE html>
<html>
<head>
    <title>PlanningGame</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Niks.Apps.TeamPicker",{constructor:function(){this.callParent()}}),Ext.define("Niks.Apps.PlanningGame",{extend:"Rally.app.App",componentCls:"app",_GC:{},config:{configFieldName:"c_PlanningPokerConfig",configSplitter:"^"},statics:{SAVE_FAIL_RETRIES:5},listeners:{configsave:function(){this._saveProjectConfig()},configchanged:function(){this._GC.updateNamedConfig(iterConfigName,this._IC.getConfig()),this._GC.updateNamedConfig(userConfigName,this._UC.getConfig()),this._saveProjectConfig().then({success:function(){this._reloadGame()},failure:function(e){console.log("Failed to save project config",e)},scope:this})},refresh:function(){Rally.ui.notify.Notifier.show({message:"Refreshing Game"}),this._getProjectConfig().then({success:function(){}})},showConfig:function(){this._iAmModerator()&&this._GC.showPanel()},changeIteration:function(){this._iAmModerator()&&this._IC.showPanel()}},_reloadGame:function(){this._UC.restart(),this._kickOff()},_iAmModerator:function(){return this.getContext().getUser().ObjectID===this._GC.getModerator().get("ObjectID")},_setUpUserScreen:function(){var e=this._iAmModerator(),t=this._UC.getPanel(e);this._UC.addStories(e?this._storyStore.getRecords():null),t.show()},_kickOff:function(){var e=this;e._IC.getCurrentIteration().then({success:function(t){var o=[{property:"Iteration",value:t}];e._GC.onlyUnSizedStories()&&(o.push(Rally.data.wsapi.Filter.or([{property:"PlanEstimate",operator:"=",value:null},{property:"PlanEstimate",operator:"=",value:0}])),o=Rally.data.wsapi.Filter.and(o)),e._storyStore=Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",filters:o,context:{projectScopeUp:!1,projectScopeDown:!1},autoLoad:!0,fetch:!0,listeners:{load:function(t,o,i){i?(Rally.ui.notify.Notifier.show({message:Ext.String.format("Loaded {0} stories",o.length)}),e._setUpUserScreen()):Rally.ui.notify.Notifier.showWarning({message:"No stories found in this iteration/project node"})},scope:e}})},failure:function(e){console.log("Didn't find a 'current' iteration",e)}})},_loadGameConfig:function(){var e=this,t=this.projectStore.getRecords()[0];t.get("TeamMembers").Count>0?t.getCollection("TeamMembers").load({fetch:!0,callback:function(t,o,i){!0===i?(Rally.ui.notify.Notifier.show({message:"Team members loaded"}),_.each(t,function(t){e._UC.addUser(t)}),e._kickOff()):console.log("Team members field unavailable")},scope:e}):Rally.ui.notify.Notifier.showWarning({message:"Team members not configured"})},launch:function(){var e=this;e._GC=Ext.create("Niks.Apps.PokerGameConfig",{app:e,project:e.getContext().getProject()}),e._UC=Ext.create("Niks.Apps.PokerUserConfig",{app:e,project:e.getContext().getProject()}),e._IC=Ext.create("Niks.Apps.PokerIterationConfig",{app:e,project:e.getContext().getProject()}),this._checkProjectFieldConfig().then({success:function(){this._getProjectConfig().then({success:function(t){t.hasOwnProperty("moderatorID")?e._GC.setModeratorFromId(t.moderatorID).then({success:function(){e._loadGameConfig()},failure:function(){console.log("Failed to set moderator from ID")}}):Ext.create("Rally.ui.dialog.ConfirmDialog",{title:"New Config",message:"Are you moderator for this session?",listeners:{confirm:function(){e._GC.setModerator(e.getContext().getUser()),e._saveProjectConfig().then({success:function(){e._loadGameConfig()},failure:function(e){console.log("Failed to save project config",e)},scope:e})}}})},failure:function(e){console.log(e)},scope:e})},failure:function(e){console.log(e)},scope:e})},_createStoryBrowser:function(){return Ext.create("Deft.Deferred").promise},_createUserMenu:function(){return Ext.create("Deft.Deferred").promise},_createLeadMenu:function(){return Ext.create("Deft.Deferred").promise},_checkProjectFieldConfig:function(){var e=this,t=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:"Project",fetch:!0,success:function(o){o.hasField(e.configFieldName)?t.resolve(o):t.reject("Correct Config not available")},failure:function(){t.reject("Failed to get Project Model")}}),t.promise},_getProjectConfig:function(){var e=this,t=Ext.create("Deft.Deferred"),o=this.getContext().getProject();return e.projectStore=Ext.create("Rally.data.wsapi.Store",{model:"Project",filters:[{property:"ObjectID",value:o.ObjectID}],autoLoad:!0,fetch:!0,listeners:{load:function(o,i){e._GC.initialiseConfig(i[0].get(this.configFieldName)),e._UC.setConfig(e._GC.getNamedConfig(userConfigName)),e._IC.setConfig(e._GC.getNamedConfig(iterConfigName));var r=e._GC.getNamedConfig(mainConfigName);t.resolve(r)},scope:e}}),t.promise},_failedSave:0,_saveProjectConfig:function(e){var t=void 0===e?Ext.create("Deft.Deferred"):e,o=this._GC.getGameConfig(),i=this.projectStore.getRecords()[0];return i.set(this.configFieldName,o),i.save({success:function(){this._failedSave=0,Rally.ui.notify.Notifier.show({message:"Config Saved to Project"}),t.resolve()},failure:function(){this._failedSave<this.self.SAVE_FAIL_RETRIES?this._saveProjectConfig(t):t.reject("Failed to save Project Config")},scope:this}),t.promise},_checkConfigChange:function(e){console.log(e)},_createConfigPage:function(){return Ext.create("Deft.Deferred").promise},_createUserPage:function(){return Ext.create("Deft.Deferred").promise},_createLeadPage:function(){return Ext.create("Deft.Deferred").promise}});
                const modChange="moderatorchanged",configChange="configchanged",mainConfigName="MainConfig",userConfigName="UserConfig",iterConfigName="IterConfig",cardWidth=400,cardHeight=200,cardMargin=10,cardSizeField="PlanEstimate",cardIdField="FormattedID",configSplitter1="^",configSplitter2="|",votingTime=10;
                Ext.define("Niks.Apps.Panel",{bubbleEvents:[],constructor:function(n){Ext.applyIf(this,n)},getPanel:function(n){return this.configPanel||this._createPanel(n)},showPanel:function(){this.getPanel().show()},hidePanel:function(){this.getPanel().hide()}});
                Ext.define("Niks.Apps.PokerGameConfig",{extend:Niks.Apps.Panel,userIDs:[],moderatorUser:null,statics:{userIdField:"ObjectID",votingTime:"10"},initialiseConfig:function(e){this[mainConfigName]=this._decodeConfig(mainConfigName,e),this[userConfigName]=this._decodeConfig(userConfigName,e),this[iterConfigName]=this._decodeConfig(iterConfigName,e)},getNamedConfig:function(e){return this[e]||{}},updateNamedConfig:function(e,i){this[e]=i},_decodeConfig:function(e,i){if(void 0===i||0===i.length)return{};var t=i.split(configSplitter1),n={};return _.each(t,function(e){var i=e.split(configSplitter2);i[0].length&&(n[i[0]]=i[1])}),JSON.parse(n[e]||"{}")},addUser:function(e){_.find(this.userIDs,{userOID:e.get(this.self.userIdField)})?console.log("Adding existing member - ignoring!"):this.userIDs.push(e[this.self.userIdField])},getModerator:function(){return this.moderatorUser?this.moderatorUser:null},setModerator:function(e){this[mainConfigName].moderatorID=e.get(this.self.userIdField),this.moderatorUser=e},setModeratorFromId:function(e){var i=this,t=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"User",autoLoad:!0,filters:[{property:this.self.userIdField,value:e}],listeners:{load:function(e,n,o){o?(i.setModerator(n[0]),t.resolve(n[0])):t.reject()}}}),t.promise},onlyUnSizedStories:function(){return this[mainConfigName].onlyUnsized},_encodeMsg:function(e,i){return configSplitter1+e+configSplitter2+i},_decodeMsg:function(e,i){return i.split(configSplitter2).pop()},getGameConfig:function(){return this._encodeMsg(mainConfigName,JSON.stringify(this[mainConfigName]))+this._encodeMsg(userConfigName,JSON.stringify(this[userConfigName]))+this._encodeMsg(iterConfigName,JSON.stringify(this[iterConfigName]))},_createPanel:function(){var e=this,i=Ext.create("Ext.panel.Panel",{floating:!0,width:400,height:400,baseCls:"configPanel",hidden:!0,closable:!0,closeAction:"hide"});return i.add({xtype:"field",id:"curMod",fieldLabel:"Current Moderator",labelWidth:200,margin:"10 0 10 20",baseBodyCls:"textfield",readOnly:!0,value:e.moderatorUser?e.moderatorUser.get("UserName"):"Not Set"}),i.add({xtype:"rallyusercombobox",id:"modChooser",fieldLabel:"Change Moderator To",valueField:this.self.userIdField,labelWidth:200,margin:"10 0 10 20",autoSelect:!1,listeners:{setvalue:function(t){null!==t.value&&(e.setModerator(t.lastSelection[0]),i.down("#curMod").setValue(e.moderatorUser.get("UserName")),Ext.create("Rally.ui.dialog.ConfirmDialog",{title:"New Moderator",message:"Restart session?",listeners:{confirm:function(){e.app.fireEvent(configChange),e.hidePanel()}}}))}}}),i.add({xtype:"rallycheckboxfield",fieldLabel:"Fetch Unsized Only",id:"unsizedOnly",value:e[mainConfigName].onlyUnsized,labelWidth:200,margin:"10 0 10 20",listeners:{change:function(i,t,n,o){e[mainConfigName].onlyUnsized=t,e.app.fireEvent(configChange)}}}),i.add({xtype:"textfield",baseCls:"timerText",fieldLabel:"Voting Time (min:sec)",labelWidth:200,margin:"10 0 10 20",value:Ext.Date.format(Ext.Date.parse(this[mainConfigName].votingTime,"s"),"i:s")||Ext.Date.format(Ext.Date.parse(votingTime,"s"),"i:s"),validator:function(i){return void 0!==Ext.Date.parse(i,"i:s")&&(e.app.fireEvent("configsave"),!0)}}),this.configPanel=i,i}});
                Ext.define("Niks.PokerCard",{extend:Ext.panel.Panel,margin:cardMargin,layout:"vbox",autoScroll:!0,constructor:function(e){Ext.apply(this.config),this.callParent(arguments);var t=this.card.get(cardSizeField);t=null===t?0===t?"set to zero":"not set":t.toString(),this.add({xtype:"text",margin:cardMargin,text:"Current Size: "+t}),this.add({xtype:"label",margin:cardMargin,grow:!0,labelAlign:"top",readOnly:!0,autoScroll:!0,html:this.card.get("Description")}),this.on("click",function(){})},config:{}}),Ext.define("Niks.Apps.PokerUserConfig",{extend:Niks.Apps.Panel,users:[],stories:[],userConfigName:{valueSeries:[0,1,2,3,5,8,13,20,50,100]},getConfig:function(){return this[userConfigName]},setConfig:function(e){this[userConfigName]=e},addUser:function(e){_.find(this.users,function(t){if(e.get("ObjectID")===t.get("ObjectID"))return!0})||this.users.push(e)},getModeratorPanel:function(){},restart:function(){this.stories=[],this.getPanel().down("#cardspace").removeAll()},addStories:function(e){var t=this;null===e||_.each(e,function(e){t._addCardToPage(e)})},_addCardToPage:function(e){_.find(this.stories,function(t){return e.get(cardIdField)===t})||(this.stories.push(e.get(cardIdField)),this.getPanel().down("#cardspace").add(Ext.create("Niks.PokerCard",{title:Ext.String.format('<a target="_blank" href={1}>{0} </a><a target="_blank" href={2} class="icon-chat"></a>',e.get(cardIdField),Rally.nav.Manager.getDetailUrl(e,{subPage:""}),Rally.nav.Manager.getDetailUrl(e,{subPage:"discussion"})),width:cardWidth,height:cardHeight,card:e})))},_createPanel:function(e){var t=this;this.userOrModerator=e;var a=t.configPanel=Ext.create("Ext.container.Container",{width:"100%",height:"auto",layout:"hbox",id:"userPage",items:[{xtype:"container",id:"menu",width:100,margin:cardMargin,cls:"clearpanel"},{xtype:"container",id:"cardspaceparent",width:"50%",flex:1,cls:"clearpanel"},{xtype:"container",id:"actions",width:400,cls:"clearpanel"}]});t.app.add(a);var n=a.down("#cardspaceparent");n.removeCls("x-panel-body-default");var r=Math.floor(n.getWidth()/(cardWidth+2*cardMargin));return r=r>0?r:1,n.add({xtype:"panel",id:"cardspace",margin:10,layout:{type:"table",columns:r},bodyCls:"userpanel"}),this.userOrModerator&&(a.down("#menu").add({xtype:"rallybutton",width:100,text:"Config",margin:"10 10 0 10",handler:function(){t.app.fireEvent("showConfig")}}),a.down("#menu").add({xtype:"rallybutton",width:100,text:"Iteration",margin:"10 10 0 10",handler:function(){t.app.fireEvent("changeIteration")}})),a.down("#menu").add({xtype:"rallybutton",width:100,text:"Refresh",margin:"10 10 0 10",handler:function(){t.app.fireEvent("refresh")}}),a}});
                Ext.define("Niks.Apps.PokerIterationConfig",{extend:Niks.Apps.Panel,constructor:function(){this.callParent(arguments),this[iterConfigName]={currentIteration:null}},getConfig:function(){return this[iterConfigName]},setConfig:function(e){Ext.merge(this[iterConfigName],e)},_createPanel:function(){var e=this,t=Ext.create("Ext.panel.Panel",{title:"Iteration Config",floating:!0,width:400,baseCls:"configPanel",hidden:!0,closable:!0,closeAction:"hide"});return e.getCurrentIteration().then({success:function(r){t.add({xtype:"rallyiterationcombobox",margin:40,store:e.iterationStore,value:r,listeners:{select:function(t,r){e[iterConfigName].currentIteration=r.get("_ref"),e.app.fireEvent("configChanged")}}})}}),e.configPanel=t,t},getCurrentIteration:function(){if(null===this[iterConfigName].currentIteration)return this._getIterations();var e=Ext.create("Deft.Deferred");return e.resolve(this[iterConfigName].currentIteration),e.promise},_getIterations:function(){var e=this,t=Ext.create("Deft.Deferred");return this._iterationStore=Ext.create("Rally.data.wsapi.Store",{model:Ext.identityFn("Iteration"),autoLoad:!0,context:{projectScopeUp:!1,projectScopeDown:!1},fetch:["Name","StartDate","EndDate","ObjectID","State","PlannedVelocity"],filters:[{property:"EndDate",operator:">",value:new Date}],sorters:[{property:"StartDate",direction:"ASC"}],listeners:{load:function(r,n,i){i?(e.iterationStore=r,e[iterConfigName].currentIteration=n[0].get("_ref"),t.resolve(e[iterConfigName].currentIteration)):(Rally.ui.notify.Notifier.showWarning({message:"No appropriate Iterations available"}),t.reject())}}}),t.promise}});

            Rally.launchApp('Niks.Apps.PlanningGame', {
                name:"PlanningGame",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        .userpanel{border-left:1px solid black;border-top:none;border-right:1px solid black;border-bottom:none;background-color:whitesmoke}.clearpanel{border:none}.configPanel{opacity:1;background-color:palegoldenrod}.textfield{border-style:none none solid none;border-color:black;border-width:1px}.timerText{font-size:18;font:1em sans-serif}
    </style>
</head>
<body>
</body>
</html>
