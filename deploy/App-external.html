<!DOCTYPE html>
<html>
<head>
    <title>PlanningGame</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Niks.Apps.TeamPicker",{constructor:function(){this.callParent()}}),Ext.define("Niks.Apps.PlanningGame",{extend:"Rally.app.App",componentCls:"app",_GC:{},config:{configFieldName:"c_PlanningPokerConfig",configSplitter:"^"},statics:{SAVE_FAIL_RETRIES:5},listeners:{moderatorchanged:function(e){this._saveProjectConfig().then({success:function(){this._reloadGame()},failure:function(e){console.log("Failed to save project config",e)},scope:this})}},_reloadGame:function(){this._kickOff()},_kickOff:function(){var e=this;this._getCurrentIteration().then({success:function(t){var o=[];e._GC.includeSizedStories()&&o.push({property:"PlanEstimate",operator:">",value:0}),e._storyStore=Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",filters:o,context:{projectScopeUp:!1,projectScopeDown:!1},autoLoad:!0,listeners:{load:function(t,o,r){r?(Rally.ui.notify.Notifier.show({message:Ext.String.format("Loaded {0} stories",o.length)}),e._GC.showPanel()):Rally.ui.notify.Notifier.showWarning({message:"No stories found in this project node"})}}})},failure:function(e){console.log("Didn't find a 'current' iteration",e)}})},_loadGameConfig:function(){var e=this,t=this.projectStore.getRecords()[0];t.get("TeamMembers").Count>0?t.getCollection("TeamMembers").load({fetch:!0,callback:function(t,o,r){!0===r?(Rally.ui.notify.Notifier.show({message:"Team members loaded"}),_.each(t,function(t){e._UC.addUser(t)}),e._kickOff()):console.log("Team members field unavailable")},scope:e}):Rally.ui.notify.Notifier.showWarning({message:"Team members not configured"})},launch:function(){var e=this;e._GC=Ext.create("Niks.Apps.PokerGameConfig",{app:e,project:e.getContext().getProject()}),e._UC=Ext.create("Niks.Apps.PokerUserConfig",{app:e,project:e.getContext().getProject()}),this._checkProjectFieldConfig().then({success:function(t){this._getProjectConfig(t).then({success:function(t){var o={};t.length&&void 0!==(o=JSON.parse(t)).moderator?e._GC.setModeratorFromId(o.moderator).then({success:function(){e._loadGameConfig()},failure:function(){console.log("Failed to set moderator from ID")}}):Ext.create("Rally.ui.dialog.ConfirmDialog",{title:"New Config",message:"Are you moderator for this session?",listeners:{confirm:function(){e._GC.setModerator(e.getContext().getUser()),e._saveProjectConfig().then({success:function(){e._loadGameConfig()},failure:function(e){console.log("Failed to save project config",e)},scope:e})}}})},failure:function(e){console.log(e)},scope:e})},failure:function(e){console.log(e)},scope:e})},_createStoryBrowser:function(){return Ext.create("Deft.Deferred").promise},_createUserMenu:function(){return Ext.create("Deft.Deferred").promise},_createLeadMenu:function(){return Ext.create("Deft.Deferred").promise},_checkProjectFieldConfig:function(){var e=this,t=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:"Project",fetch:!0,success:function(o){o.hasField(e.configFieldName)?t.resolve(o):t.reject("Correct Config not available")},failure:function(){t.reject("Failed to get Project Model")}}),t.promise},_getProjectConfig:function(e){var t=this,o=Ext.create("Deft.Deferred"),r=this.getContext().getProject();return t.projectStore=Ext.create("Rally.data.wsapi.Store",{model:e.typeDefName,filters:[{property:"ObjectID",value:r.ObjectID}],autoLoad:!0,fetch:!0,listeners:{load:function(e,r){t._GC.initialiseConfig(r[0].get(this.configFieldName));var i=t._GC.getNamedConfig(mainConfigName);o.resolve(i)},scope:t}}),o.promise},_failedSave:0,_saveProjectConfig:function(e){var t=void 0===e?Ext.create("Deft.Deferred"):e,o=JSON.stringify(this._GC.getGameConfig()),r=this.projectStore.getRecords()[0];return r.set(this.configFieldName,o),r.save({success:function(){this._failedSave=0,Rally.ui.notify.Notifier.show({message:"Config Saved to Project"}),t.resolve()},failure:function(){this._failedSave<this.self.SAVE_FAIL_RETRIES?this._saveProjectConfig(t):t.reject("Failed to save Project Config")},scope:this}),t.promise},_checkConfigChange:function(e){console.log(e)},_createConfigPage:function(){return Ext.create("Deft.Deferred").promise},_createUserPage:function(){return Ext.create("Deft.Deferred").promise},_createLeadPage:function(){return Ext.create("Deft.Deferred").promise},_getCurrentIteration:function(){var e=Ext.create("Deft.Deferred");return this._iterationStore=Ext.create("Rally.data.wsapi.Store",{model:"Iteration",autoLoad:!0,context:{projectScopeUp:!1,projectScopeDown:!1},filters:[{property:"StartDate",operator:"<",value:new Date},{property:"EndDate",operator:">",value:new Date}],listeners:{load:function(t,o,r){e.resolve(o[0])}}}),e.promise}});
                const modChange="moderatorchanged",mainConfigName="MainConfig",userConfigName="UserConfig",iterConfigName="IterConfig";
                Ext.define("Niks.Apps.Panel",{bubbleEvents:[],constructor:function(n){Ext.applyIf(this,n)},getPanel:function(){return void 0===this.configPanel&&this._createPanel(),this.configPanel},showPanel:function(){this.getPanel().show()},hidePanel:function(){this.getPanel().hide()}});
                Ext.define("Niks.Apps.PokerGameConfig",{extend:Niks.Apps.Panel,userIDs:[],moderatorUser:null,statics:{userIdField:"ObjectID"},initialiseConfig:function(e){this[mainConfigName]=this._decodeConfig(mainConfigName,e),this[userConfigName]=this._decodeConfig(userConfigName,e),this[iterConfigName]=this._decodeConfig(iterConfigName,e)},getNamedConfig:function(e){return this[e]||{}},_decodeConfig:function(e,i){if(void 0===i||0===i.length)return"";var t=i.split(this.configSplitter),n={};return _.each(t,function(e){var i=e.split(",");i[0].length&&(n[i[0]]=i[1])}),n[e]||{}},addUser:function(e){_.find(this.userIDs,{userOID:e.get(this.self.userIdField)})?console.log("Adding existing member - ignoring!"):this.userIDs.push(e[this.self.userIdField])},setModerator:function(e){this[mainConfigName].moderatorID=e[this.self.userIdField],this.moderatorUser=e},setModeratorFromId:function(e){var i=this,t=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"User",autoLoad:!0,filters:[{property:this.self.userIdField,value:e}],listeners:{load:function(e,n,o){o?(i.setModerator(n[0].data),t.resolve(n[0].data)):t.reject()}}}),t.promise},includeSizedStories:function(){return!this.onlyUnsized},_encodeMsg:function(e,i){return this.configSplitter+e+","+window.btoa(i)},_decodeMsg:function(e,i){return window.atob(i.split(",").pop())},getGameConfig:function(){return this._encodeMsg(mainConfigName,JSON.stringify(this.mainConfig))+this._encodeMsg(userConfigName,JSON.stringify(this.userConfig))+this._encodeMsg(iterConfigName,JSON.stringify(this.iterationConfig))},_createPanel:function(){var e=this,i=Ext.create("Ext.container.Container",{floating:!0,width:400,height:400,baseCls:"panel",hidden:!0});return i.add({xtype:"field",id:"curMod",fieldLabel:"Current Moderator",labelWidth:200,margin:"10 0 10 20",baseBodyCls:"textfield",readOnly:!0,value:e.moderatorUser?e.moderatorUser.DisplayName:"Not Set"}),i.add({xtype:"rallyusercombobox",id:"modChooser",labelWidth:200,fieldLabel:"Change Moderator To",valueField:this.self.userIdField,margin:"10 0 10 20",autoSelect:!1,listeners:{setvalue:function(t){null!==t.value&&(e.setModerator(t.lastSelection[0]),i.down("#curMod").setValue(e.moderatorUser.get("DisplayName")),Ext.create("Rally.ui.dialog.ConfirmDialog",{title:"New Moderator",message:"Restart session?",listeners:{confirm:function(){e.app.fireEvent(modChange),e.hidePanel()}}}))}}}),this.configPanel=i,i}});
                Ext.define("Niks.Apps.PokerUserConfig",{extend:Niks.Apps.Panel,users:[],addUser:function(e){_.find(this.users,function(s){if(e.get("ObjectID")===s.get("ObjectID"))return!0})||this.users.push(e)}});

            Rally.launchApp('Niks.Apps.PlanningGame', {
                name:"PlanningGame",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        .panel{border:'1px black'}.textfield{border-style:none none solid none;border-color:black;border-width:1px}
    </style>
</head>
<body>
</body>
</html>
