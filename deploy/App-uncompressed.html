<!DOCTYPE html>
<html>
<head>
    <title>PlanningGame</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                
Ext.define('Niks.Apps.TeamPicker', {
    constructor: function() {
        this.callParent();
    }
});

Ext.define('Niks.Apps.PlanningGame', {
    extend: 'Rally.app.App',
    componentCls: 'app',

    //Only save the least amount of data in here. We only have 32768 chars to play with
    _GC: {},

    config: {
        configFieldName: "c_PlanningPokerConfig",
        configSplitter: '^'
    },

    statics: {
        SAVE_FAIL_RETRIES: 5
    },

    listeners: {
        moderatorchanged: function(evt) {
            this._saveProjectConfig().then({
            success: function() {
                /** Config saved and restart from scratch */
                this._reloadGame();
            },
            failure: function(e) {
                console.log("Failed to save project config",e);
            },
            scope: this
        });
        }
    },

    _reloadGame: function() {
        /** Clear out existing data and settings 
         * We will need to refetch the config from the project 
         * */
        this._kickOff();
    },

    _kickOff: function() {
        var me = this;
        /** When we come here, everything should be in place to start a new game
         * Now fetch the User Stories - with the option of only those not sized yet
         */
        this._getCurrentIteration().then({
            success: function(iteration) {
                var filters = [];

                if (me._GC.includeSizedStories()) {
                    filters.push({
                        property: 'PlanEstimate',
                        operator: '>',
                        value: 0
                    });
                }

                me._storyStore = Ext.create('Rally.data.wsapi.Store', {
                    model: 'HierarchicalRequirement',
                    filters: filters,
                    context: {
                        projectScopeUp: false,
                        projectScopeDown: false
                    },
                    autoLoad: true,
                    listeners: {
                        load: function(store, records, success) {
                            if (success) {
                                Rally.ui.notify.Notifier.show({message: Ext.String.format("Loaded {0} stories", records.length)});
                                me._GC.showPanel();
                            }else {
                                Rally.ui.notify.Notifier.showWarning({message: "No stories found in this project node"});
                            }
                        }
                    }
                });
            },
            failure: function(e) {
                console.log("Didn't find a 'current' iteration", e);
            }
        });

    },

    _loadGameConfig: function() {
        var me = this;

        /** We need to load up the project specific config now.
         * Firstly, we need the team members
         */
        var record = this.projectStore.getRecords()[0];
        if ( record.get('TeamMembers').Count > 0) {
            record.getCollection('TeamMembers').load( {
                fetch: true,
                callback: function( members, operation, success) {
                    //Add all the team members to the GameConfig
                    if (success === true) {
                        Rally.ui.notify.Notifier.show({ message: "Team members loaded"});
                        _.each(members, function(member) {
                            me._UC.addUser(member);
                        });
                        me._kickOff();
                    }
                    else {
                        console.log("Team members field unavailable");
                    }
                },
                scope: me
            });
        }
        else {
            Rally.ui.notify.Notifier.showWarning({ message: "Team members not configured"});
        }

    },

    launch: function () {
        var me = this;
        me._GC = Ext.create('Niks.Apps.PokerGameConfig', {
            app: me,
            project: me.getContext().getProject()
        });

        me._UC = Ext.create('Niks.Apps.PokerUserConfig', {
            app: me,
            project: me.getContext().getProject()
        });

        //Check for required fields in this project node

        //Create config page and then pull config from project node if exists. If not, create.
        //If not config already, ask the user if they are to be the Moderator for this.

        /** Set up a timer that reads the config every 1sec so that we pull changes from other users
         * 
         */

        this._checkProjectFieldConfig().then( {
            success: function(result) {
                this._getProjectConfig(result).then({
                    success: function(projConfig) {
                        var previousConfig = {};
                        debugger;
                        if (projConfig.length && ((previousConfig = JSON.parse(projConfig)).moderator !== undefined)){
                            // Ready to go
                            //get the moderator from the saved config ID and give it to the gameConfig to fetch the full user
                            me._GC.setModeratorFromId(previousConfig.moderator). then ({
                                success: function() {
                                    me._loadGameConfig();
                                },
                                failure: function() {
                                    console.log('Failed to set moderator from ID');
                                }
                            });
                        }
                        else {
                            //Set up new config
                            Ext.create('Rally.ui.dialog.ConfirmDialog', {
                                title: "New Config",
                                message: "Are you moderator for this session?",
                                listeners: {
                                    confirm: function() {
                                        //Set user up as moderator
                                        me._GC.setModerator( me.getContext().getUser());
                                        me._saveProjectConfig().then({
                                            success: function() {
                                                /** Config saved and we are ready to go */
                                                me._loadGameConfig();
                                            },
                                            failure: function(e) {
                                                console.log("Failed to save project config",e);
                                            },
                                            scope: me
                                        });
                                    }
                                }
                            });
                        }
                    },
                    failure: function(e) {
                        console.log(e);
                    },
                    scope: me
                });
            },
            failure: function(e) {
                console.log(e);
            },
            scope: me
        });

    },

    _createStoryBrowser: function() {
        var deferred = Ext.create("Deft.Deferred");
        return deferred.promise;

    },

    _createUserMenu: function() {
        /** Each user must have a way to save and restore their current settings/layout */
        var deferred = Ext.create("Deft.Deferred");
        return deferred.promise;

    },

    _createLeadMenu: function() {
        /** Lead menu must have access to the config page */
        var deferred = Ext.create("Deft.Deferred");
        return deferred.promise;

    },

    /** Make sure that the system is set up the way we need */
    _checkProjectFieldConfig: function() {
        var me = this;
        //Check field PlanningConfig exists on project model
        var deferred = Ext.create("Deft.Deferred");

        Rally.data.ModelFactory.getModel({
            type: "Project",
            fetch: true,
            success: function(model) {
                //Add any prechecks here
                if (model.hasField(me.configFieldName)) {
                    deferred.resolve(model);
                } else {
                    //Here, we need to ask if they want to set up the new field (need to be workspace admin)
                    deferred.reject("Correct Config not available");
                }
            },
            failure: function() {
                //Shouldn't happen unless Rally is down
                deferred.reject("Failed to get Project Model");
            }
        });
        return deferred.promise;
    },

    /** As the game progresses, we need to save the state of the game. 
     * We will need to do retries due to concurrency errors that we might get with a number
     * of people trying to update the same field on the Project.
     * 
     * We also will need to be able to reload the last config to get back to where we were 
     * in the game before, if there is ever any issues (browser crash, network error, etc., etc.)
     *  For this, we should put a "refresh" button on the top menu bar
    */
    
    _getProjectConfig: function(model) {   /** parameter provided is Project Model, but not the actual data */
        var me = this;
        var deferred = Ext.create("Deft.Deferred");
        /** 
         * The current context should contain the Project record that we are currently at. 
         * We could change this to be a project picker if that becomes a useful feature.
         * Even if we update the Project field, then the environment keeps that handily local.
        */

        var project = this.getContext().getProject();
        me.projectStore = Ext.create( 'Rally.data.wsapi.Store', {
            model: model.typeDefName,
            filters: [{
                property: 'ObjectID',
                value: project.ObjectID
            }],
            autoLoad: true,
            fetch: true,
            listeners: {
                load: function(store, records) {
                    me._GC.initialiseConfig(records[0].get(this.configFieldName));
                    var currentConfig = me._GC.getNamedConfig(mainConfigName);
                    deferred.resolve(currentConfig);
                },
                scope: me
            }
        });

        return deferred.promise;
    },

    _failedSave: 0,

    /** Save the current config */
    _saveProjectConfig: function(existingDefer) {
        var me = this;
        var deferred = (existingDefer === undefined) ? Ext.create("Deft.Deferred") : existingDefer;
        var currentConfig = JSON.stringify(this._GC.getGameConfig());
        var record = this.projectStore.getRecords()[0];
        record.set(this.configFieldName, currentConfig);
        record.save({
            success: function() {
                this._failedSave = 0;
                Rally.ui.notify.Notifier.show({ message: "Config Saved to Project"});
                deferred.resolve();
            },
            failure: function() {
                if (this._failedSave < this.self.SAVE_FAIL_RETRIES) {
                    this._saveProjectConfig(deferred);
                }
                else {
                    deferred.reject("Failed to save Project Config");
                }
            },
            scope: me
        });
        return deferred.promise;
    },

    _checkConfigChange: function(newConfig) {
        console.log(newConfig);
    },

    //Create and hide the config page
    _createConfigPage: function() {
        /** Config page must have:
         * 1. Moderator Chooser
         * 2. Team member list - enables for this session
         * 3. Timer countdown duration
         * 4. Iteration for this session
         */
        var deferred = Ext.create("Deft.Deferred");
        return deferred.promise;
    },

    /** Make the main pages that the game players need
     * 
     */
    _createUserPage: function() {
        var deferred = Ext.create("Deft.Deferred");
        return deferred.promise;
    },

    _createLeadPage: function() {
        var deferred = Ext.create("Deft.Deferred");
        return deferred.promise;
    },

    _getCurrentIteration: function() {

        /** In this project, find the iteration that is ongoing */
        var deferred = Ext.create("Deft.Deferred");

        this._iterationStore = Ext.create('Rally.data.wsapi.Store', {
            model: 'Iteration',
            autoLoad: true,
            context: {
                projectScopeUp: false,
                projectScopeDown: false
            },
            filters: [
                {
                    property: "StartDate",
                    operator: "<",
                    value: new Date()
                },
                {
                    property: 'EndDate',
                    operator: ">",
                    value: new Date()
                }
            ],
            listeners: {
                load: function(store, records, success) {
                    deferred.resolve(records[0]);
                }
            }
        });
        return deferred.promise;
    },
});

                /** Event Passing */
const modChange = 'moderatorchanged';

/** Configuration naming  */
const mainConfigName = 'MainConfig';
const userConfigName = 'UserConfig';
const iterConfigName = 'IterConfig';
                Ext.define('Niks.Apps.Panel', {

    bubbleEvents: [],

    constructor: function(config) {
        //this.callParent(arguments);
        Ext.applyIf(this, config);
    },

    getPanel: function() {
        if (this.configPanel === undefined) {
            this._createPanel();
        }
        return this.configPanel;
    },

    showPanel: function() {
        this.getPanel().show();
    },

    hidePanel: function() {
        this.getPanel().hide();
    },

});

                
Ext.define('Niks.Apps.PokerGameConfig', {
    extend: Niks.Apps.Panel,

    /** Each interation might have different config
    iterationConfig: {}, 
    */
   /**
    mainConfig: {
        activeStory: null,
        moderatorID: null,
        onlyUnsized: false,
    },
     */
    /** 
    userConfig: {}, //Contains 'active' as well as other layout info for this game 
     */

    userIDs: [],            /** Only contains the reference to the user only so that we can get info from UserConfig */
    moderatorUser: null,    /** Full object for the moderator */
    
    statics: {
        userIdField: "ObjectID"
    },

    /** We know of three config types right now: MainConfig, IterationConfig, UserConfig */
    initialiseConfig: function(fieldText) {
        this[mainConfigName] = this._decodeConfig(mainConfigName, fieldText);
        this[userConfigName] = this._decodeConfig(userConfigName, fieldText);
        this[iterConfigName] = this._decodeConfig(iterConfigName, fieldText);
    },

    getNamedConfig: function(name) {
        return this[name] || {};
    },

    _decodeConfig: function(requiredType, fieldText) {

        if ((fieldText === undefined) || ( fieldText.length === 0)) {
            return '';
        }
        var msgs = fieldText.split(this.configSplitter);
        var configs = {};
        _.each(msgs, function(msg) {
            var splitMsg = msg.split(',');
            if (splitMsg[0].length) {
                configs[splitMsg[0]] = splitMsg[1];
            }
        });
        return configs[requiredType] || {};
    },

    addUser: function(user) {   //Passed in a user record
        if ( _.find( this.userIDs, {userOID: user.get(this.self.userIdField)})) {
            console.log("Adding existing member - ignoring!");
        } else {
            this.userIDs.push(user[this.self.userIdField]);
        }
    },

    setModerator: function(user) {
        this[mainConfigName].moderatorID = user[this.self.userIdField];
        this.moderatorUser = user;
    },

    setModeratorFromId: function(id) {
        var me = this;
        var deferred = Ext.create('Deft.Deferred');
        Ext.create('Rally.data.wsapi.Store', {
            model: 'User',
            autoLoad: true,
            filters: [
                {
                    property: this.self.userIdField,
                    value: id
                }
            ],
            listeners: {
                load: function(store, records, success) {
                    if (success) {
                        me.setModerator(records[0].data);
                        deferred.resolve(records[0].data);
                    }
                    else {
                        deferred.reject();
                    }
                }
            }
        });
        return deferred.promise;
    },

    includeSizedStories: function() {
        return !this.onlyUnsized;
    },

    _encodeMsg: function(msgType, msgText) {
        return this.configSplitter + msgType + "," + window.btoa(msgText);
    },

    _decodeMsg: function(msgType, msgText) {
        return window.atob(msgText.split(",").pop());
    },

    /* Gameconfig is the thing that is stored to the Project field. Must not be more than 32768 chars */
    getGameConfig: function() {
        return  this._encodeMsg(mainConfigName, JSON.stringify(this.mainConfig)) +
                this._encodeMsg(userConfigName, JSON.stringify(this.userConfig))+
                this._encodeMsg(iterConfigName, JSON.stringify(this.iterationConfig));
    },

    _createPanel: function() {
        var me = this;
        var panel = Ext.create('Ext.container.Container', {
            floating: true,
            width: 400,
            height: 400,
            baseCls: 'panel',
            hidden: true
        });
        panel.add( {
            xtype: 'field',
            id: 'curMod',
            fieldLabel: 'Current Moderator',
            labelWidth: 200,            
            margin: '10 0 10 20',
            baseBodyCls: 'textfield',
            readOnly: true,
            value: me.moderatorUser? me.moderatorUser['DisplayName']: 'Not Set'

        });
        panel.add( {
            xtype: 'rallyusercombobox',
            id: 'modChooser',
            labelWidth: 200,
            fieldLabel: 'Change Moderator To',
            valueField: this.self.userIdField,
            margin: '10 0 10 20',
            autoSelect: false,
            listeners: {
                //Setvalue fires when the thing is first set up with a null value.
                setvalue: function(entry) {
                    if (entry.value !== null) {
                        me.setModerator(entry.lastSelection[0]);
                        panel.down('#curMod').setValue(me.moderatorUser.get('DisplayName'));
                        Ext.create('Rally.ui.dialog.ConfirmDialog', {
                                title: "New Moderator",
                                message: "Restart session?",
                                listeners: {
                                    confirm: function() {
                                        //Set user up as moderator
                                        me.app.fireEvent(modChange);
                                        me.hidePanel();
                                    }
                                }
                            });
                        
                    }
                },
            }
        });

        this.configPanel = panel;
        return panel;
    },
});
                /** Something to hold the current config of the user during this session
 * 
 */

Ext.define('Niks.Apps.PokerUserConfig', {
    extend: Niks.Apps.Panel,
    users: [],

    /* This is called from something that has got a Store record not just a model */
    addUser: function(userRecord) {
        /** Check if the user is in the array. If not, then add */
        if (!_.find(this.users, function(user) {
            if (userRecord.get('ObjectID') === user.get('ObjectID')) {
                return true;
            }
        })){
            this.users.push(userRecord);
        }
    }

});

            Rally.launchApp('Niks.Apps.PlanningGame', {
                name:"PlanningGame",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>



    <style type="text/css">
        .panel {
  border: '1px black';
}
.textfield {
  border-style: none none solid none;
  border-color: black;
  border-width: 1px;
}

    </style>
</head>
<body>
</body>
</html>
